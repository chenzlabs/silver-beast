<html>
  <head>
    <script src="https://rawgit.com/aframevr/aframe/master/dist/aframe-master.min.js"></script>
    
    <!-- Import grid shader. -->
    <script src="grid-shader.js"></script>    

    <!-- Include ShaderFrog import. -->
    <script src="https://rawgit.com/chenzlabs/aframe-import-shaderfrog/master/aframe-import-shaderfrog.js"></script>
    
    <!-- Prevent touch causing flicker on iOS. -->
    <style> * { -webkit-tap-highlight-color: rgba(0,0,0,0); } </style>    
    
    <!-- Import physics.  FIXME: bug in 2.0.0, so use prior version. -->
    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v1.4.3/dist/aframe-physics-system.js"></script>
    
    <!-- Import legacy GLTF loader. -->
<!--
    <script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v3.12.3/dist/aframe-extras.loaders.min.js"></script> 
-->
  </head>
  <body>
    <!-- Attractor component, to hopefully apply gravity to dynamic bodies. -->
    <script>
      AFRAME.registerComponent('attractor', {
        schema: {
          g: {default: 6.67e-11},
          mass: {default: 1e9}
        },

        init: function () {
          this.tempPosition = new CANNON.Vec3();
          this.tempForce = new CANNON.Vec3();
          this.forceDelta = new CANNON.Vec3();
        },

        tick: function (t, dt) {
          var dbs = this.el.sceneEl.querySelectorAll('[dynamic-body]');
          for (var i=0; i<dbs.length; i++) {
            var el = dbs[i];
            var body = el.body;
            // Compute difference between body and attractor position.
            if (this.el.body) {
              this.tempPosition.copy(this.el.body.position);
            } else {
              var position = this.el.getAttribute('position');
              this.tempPosition.set(position.x, position.y, position.z);
            }
            this.tempPosition.vsub(body.position, this.tempForce);
            // Compute distance between them (magnitude of difference).
            var r = this.tempForce.length();
            // Compute attraction strength.
            var f = this.data.g * this.data.mass * body.mass / (r * r);
            // make tempForce have the correct magnitude f.
            this.tempForce.scale(f / r, this.tempForce);
            // Compute force delta. NOTE: we need to know last applied value!
            // FIXME: this will only work for one attractor...
            if (el.lastComputedAttractor) {
              this.tempForce.vsub(el.lastComputedAttractor, this.forceDelta);
            } else {
              el.lastComputedAttractor = new CANNON.Vec3().copy(this.tempForce);
              this.forceDelta.copy(this.tempForce);
            }
            // Apply force delta.
            body.applyLocalImpulse(this.forceDelta, CANNON.Vec3.ZERO);
          }
        }
      });
    </script>

    <!-- Scene declaration, with physics system parameters. -->
    <a-scene physics="gravity:0; friction:0; restitution:1">

      <!-- Mixin used to reduce redundancy in wall definitions. -->
      <a-mixin id="wall" 
        class="wall" static-body
        material="shader:grid;interval:1;color:cyan"></a-mixin>

      <!-- Prefetch a texture, but short timeout to avoid blocking. -->
      <a-assets timeout="1">
        <img id="contrast-noise" crossorigin="anonymous"
             src="https://cdn.glitch.com/2d8374de-4ed1-4bfd-a6f4-95e0d4d6a47a%2Fcontrast-noise.png?1506062505936"></img>
      </a-assets>
   
      <!-- Outer void, and skybox. -->
      <a-box id="void" scale="10000 10000 -10000" material="shader:flat;color:black"></a-box>
      <a-box id="skybox" scale="1000 1000 -1000" material="shader:flat;color:black"></a-box>
      
      <!-- Visible walls. --> 
      <!-- top    --><a-box mixin="wall" position="0 3.1 -4" width="10" height="0.2" depth="10"></a-box>
      <!-- front  --><a-box mixin="wall" position="0 1.5 -9.1" width="10" height="0.2" depth="3" rotation="-90 0 0"></a-box>
      <!-- back   --><a-box mixin="wall" position="0 1.5 1.1" width="10" height="0.2" depth="3" rotation="-90 0 0"></a-box>
      <!-- left   --><a-box mixin="wall" position="-5.1 1.5 -4" width="10" height="0.2" depth="3" rotation="-90 90 0"></a-box>
      <!-- right  --><a-box mixin="wall" position="5.1 1.5 -4" width="10" height="0.2" depth="3" rotation="-90 -90 0"></a-box>
      <!-- bottom --><a-box mixin="wall" static-body position="0 -0.1 -4" width="10" height="0.2" depth="10"></a-box>

      <!-- Invisible walls, thick to avoid passing through easily. --> 
      <!-- top    --><a-box static-body position="0 3.9 -4" width="13.6" height="1.8" depth="13.6" opacity="0"></a-box>
      <!-- front  --><a-box static-body position="0 1.5 -9.9" width="13.6" height="1.8" depth="3" rotation="-90 0 0" opacity="0"></a-box>
      <!-- back   --><a-box static-body position="0 1.5 1.9" width="10" height="1.8" depth="3" rotation="-90 0 0" opacity="0"></a-box>
      <!-- left   --><a-box static-body position="-5.9 1.5 -4" width="13.6" height="1.8" depth="3" rotation="-90 90 0" opacity="0"></a-box>
      <!-- right  --><a-box static-body position="5.9 1.5 -4" width="13.6" height="1.8" depth="3" rotation="-90 -90 0" opacity="0"></a-box>
      <!-- bottom --><a-box static-body position="0 -0.9 -4" width="13.6" height="1.8" depth="13.6" opacity="0"></a-box>

      <!-- Sun.  FIXME: body masses do not affect each other; zero gravity! -->
      <a-sphere class="sun" attractor="mass:1e9" position="0 2 -4" radius="0.2" material="shader:grid;interval:0.02;color:yellow"></a-sphere> 

      <!-- Ball to bounce around. -->
      <a-sphere class="ball" dynamic-body="mass:1;linearDamping:0;angularDamping:0" position="0.5 2 0" radius="0.1" material="shader:grid;color:cyan"></a-sphere>
      
      <!-- Disc to bounce around. -->
      <a-cylinder class="disc" dynamic-body="mass:1;linearDamping:0;angularDamping:0" position="-0.5 2 0" radius="0.1" height="0.02" material="shader:grid;color:cyan"></a-cylinder>
      
      <!-- Player avatar - here, the opponent farther away and facing. -->
      <a-entity class="head" static-body position="0 0 0" rotation="0 180 0" scale="1.2 1.2 1.2" 
                gltf-model="https://cdn.rawgit.com/KhronosGroup/glTF-Sample-Models/master/2.0/RiggedFigure/glTF-Binary/RiggedFigure.glb"
                was-gltf-model="https://cdn.aframe.io/test-models/models/glTF-2.0/brainstem/BrainStem.gltf"></a-entity>

      <!-- Player avatar - here, the local player, for spectators etc. -->
      <a-entity class="head" static-body position="0 0 -8" rotation="0 0 0" scale="1.2 1.2 1.2" 
                gltf-model="https://cdn.rawgit.com/KhronosGroup/glTF-Sample-Models/master/2.0/RiggedFigure/glTF-Binary/RiggedFigure.glb"
                was-gltf-model="https://cdn.aframe.io/test-models/models/glTF-2.0/brainstem/BrainStem.gltf"></a-entity>

      <!-- Deprecated avatar -- old glTF 1.0, which core doesn't support. -->
      <!-- a-entity class="head" static-body position="0 1.6 -5" rotation="0 180 0" scale="2.1 2.1 1.4" 
                material="src:https://aframe.io/a-saturday-night/assets/avatar3/avatar3.jpg"
                not-gltf-model-legacy="https://aframe.io/a-saturday-night/assets/avatar3/avatar3-head.gltf"></a-entity -->
    </a-scene>

    <script>
      // Define some convenience variables for scene elements we use below.
      var scene = document.querySelector('a-scene');
      var ball = scene.querySelector('.ball');
      var disc = scene.querySelector('.disc');
      var skybox = scene.querySelector('#skybox');

      // Define some things we want to do once the scene is loaded. 
      function onceSceneLoaded() {
        setTimeout(function() {
          // Get things moving.  FIXME: we want hard bounce, but not getting!?
          ball.body.velocity.set(0, 0, -10);
          disc.body.velocity.set(0, 0, -10);

          // Make things look funky!
          goElectricSphere();
        });
      }

      if (scene.hasLoaded) { onceSceneLoaded(); } else {
        scene.addEventListener('loaded', onceSceneLoaded);
      }      

      // This is how we make things look funky...
      function goElectricSphere() {
// This is the JSON for the shader we want to use.
// Really, we should load this from somewhere.
// See http://shaderfrog.com/app/view/{id}
var importedShaderJSON = String.raw`
{
  "id": 1701,
  "name": "Electric Sphere (Transparent)",
  "fragment": "precision highp float;\n\n#define PI 3.141592653589793238462643383279\n\nuniform float time;\nuniform float speed;\nuniform float resolution;\nuniform vec3 color;\nuniform sampler2D image;\nuniform float brightness;\n\nvarying vec2 vUv;\nvarying vec3 vPosition;\nvarying vec3 vNormal;\n\nvec3 lig = normalize(vec3(0.9,0.35,-0.2));\n\nvoid main() {\n    \n    vec2 uvMax = ( 2.0 * asin( sin( 2.0 * PI * vUv ) ) ) / PI;\n    vec2 position = vUv * resolution;\n    \n\tvec3 nor = vec3( 0.0, 1.0, 0.0 );\n\tfloat dif = max(dot(nor,lig),0.0);\n\t\n\tvec3 pos = vec3( position.x, 0.0, position.y );\n\t\n\tfloat timeScale = time * speed;\n\t\n\t// lights\n\tvec3 brdf = vec3(0.0);\n\tfloat cc  = 0.55*texture2D( image, 1.8*0.02*pos.xz + 0.007*timeScale*vec2( 1.0, 0.0) ).x;\n\tcc += 0.25*texture2D( image, 1.8*0.04*pos.xz + 0.011*timeScale*vec2( 0.0, 1.0) ).x;\n\tcc += 0.10*texture2D( image, 1.8*0.08*pos.xz + 0.014*timeScale*vec2(-1.0,-1.0) ).x;\n\tcc = 0.6*(1.0-smoothstep( 0.0, 0.025, abs(cc-0.4))) + \n\t\t0.4*(1.0-smoothstep( 0.0, 0.150, abs(cc-0.4)));\n\n\tvec3 col = color * cc;\n    \n    gl_FragColor = vec4( color * cc * brightness, cc * brightness );\n}\n",
  "vertex": "precision highp float;\r\nprecision highp int;\r\n\r\nuniform mat4 modelMatrix;\r\nuniform mat4 modelViewMatrix;\r\nuniform mat4 projectionMatrix;\r\nuniform mat4 viewMatrix;\r\nuniform mat3 normalMatrix;\r\n\r\nattribute vec3 position;\r\nattribute vec3 normal;\r\nattribute vec2 uv;\r\nattribute vec2 uv2;\r\n\r\nvarying vec2 vUv;\r\nvarying vec3 vPosition;\r\nvarying vec3 vNormal;\r\n\r\nvoid main() {\r\n  vUv = uv;\r\n  vPosition = position;\r\n  vNormal = normal;\r\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}",
  "uniforms": {
    "time": {
      "name": "time",
      "displayName": null,
      "type": "f",
      "glslType": "float",
      "useGridHelper": false,
      "useRange": false,
      "range": null,
      "isRandom": false,
      "randomRange": null,
      "useToggle": false,
      "toggle": null,
      "description": ""
    },
    "speed": {
      "name": "speed",
      "displayName": null,
      "type": "f",
      "glslType": "float",
      "useGridHelper": false,
      "useRange": true,
      "range": {
        "min": "0",
        "max": "2"
      },
      "isRandom": false,
      "randomRange": null,
      "useToggle": false,
      "toggle": null,
      "description": ""
    },
    "resolution": {
      "name": "resolution",
      "displayName": null,
      "type": "f",
      "glslType": "float",
      "useGridHelper": false,
      "useRange": true,
      "range": {
        "min": "0",
        "max": "10"
      },
      "isRandom": false,
      "randomRange": null,
      "useToggle": false,
      "toggle": null,
      "description": ""
    },
    "color": {
      "name": "color",
      "displayName": null,
      "type": "c",
      "glslType": "vec3",
      "useGridHelper": false,
      "useRange": false,
      "range": null,
      "isRandom": false,
      "randomRange": null,
      "useToggle": false,
      "toggle": null,
      "description": ""
    },
    "image": {
      "name": "image",
      "displayName": null,
      "type": "t",
      "glslType": "sampler2D",
      "useGridHelper": false,
      "useRange": false,
      "range": null,
      "isRandom": false,
      "randomRange": null,
      "useToggle": false,
      "toggle": null,
      "description": ""
    },
    "brightness": {
      "name": "brightness",
      "displayName": null,
      "type": "f",
      "glslType": "float",
      "useGridHelper": false,
      "useRange": true,
      "range": {
        "min": "0",
        "max": "5"
      },
      "isRandom": false,
      "randomRange": null,
      "useToggle": false,
      "toggle": null,
      "description": ""
    }
  },
  "url": "http://shaderfrog.com/app/view/1701",
  "user": {
    "username": "andrewray",
    "url": "http://shaderfrog.com/app/profile/andrewray"
  }
}
`;            
        // Import the shader.
        // Note that this one has default values in the JSON.
        AFRAME.utils.importShaderFrog(
          "electricSphere", // shader name
          importedShaderJSON,     // shader JSON string
          {
            speed: 1,
            resolution: 1, //8, // 2.33580302,
            image: '#contrast-noise',
            brightness: 25 // 5
          }
        );

        // Apply the shader to scene entities.
        ball.setAttribute('material', {shader:'electricSphere', color:'#135', transparent:true});
        disc.setAttribute('material', {shader:'electricSphere', color:'#135', transparent:true});
        skybox.setAttribute('material', {shader:'electricSphere', color:'#000103', transparent:true});
      }      
      
    </script>
  </body>
</html>
